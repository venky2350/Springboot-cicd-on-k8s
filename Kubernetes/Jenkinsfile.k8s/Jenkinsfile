pipeline {
  agent any

  environment {
    KUBECONFIG = "/root/.kube/config"
    DOCKER_IMAGE = "venkatesh384/springboot-cicd-on-k8s"
    IMAGE_TAG = "v5"
    MANIFEST_DIR = "manifests"
  }

  stages {
    stage('ğŸš€ Deploy to Kubernetes') {
      steps {
        dir("${MANIFEST_DIR}") {
          withEnv(["KUBECONFIG=${KUBECONFIG}"]) {
            sh '''
              echo "ğŸ“¦ Kubernetes Client Version:"
              kubectl version --client

              echo "ğŸ› ï¸ Applying namespace..."
              kubectl apply -f namespace.yaml || echo "Already exists"

              echo "ğŸ› ï¸ Updating deployment image..."
              sed -i "s|image: .*|image: $DOCKER_IMAGE:$IMAGE_TAG|" deployment.yaml

              echo "ğŸš€ Applying manifests..."
              kubectl apply -f deployment.yaml
              kubectl apply -f service.yaml

              echo "ğŸ“ˆ Waiting for rollout..."
              kubectl rollout status deployment/jenkins-demo -n dev
              kubectl get all -n dev
            '''
          }
        }
      }
    }
  }
}
